name: '[WPA] Automation'
on:
  schedule:
    - cron: '00 0-21/3 * * *'
    - cron: '30 1-22/3 * * *'
  workflow_dispatch:
jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
        working-directory: winget-pkgs-automation
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false
      - name: Clone microsoft/winget-pkgs
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          repository: microsoft/winget-pkgs
          path: winget-pkgs-automation/winget-pkgs
      - name: Install dependencies
        run: |
          # Initialize auth.js which will be used by the script to get bot token
          npm install @octokit/auth-app
          Write-Output 'async function main() {
            console.log((await require("@octokit/auth-app").createAppAuth({
              appId: ${{ secrets.BT_AP_ID }},
              privateKey: "${{ secrets.BT_AP_PKY }}",
              clientId: "${{ secrets.BT_CLNT_ID }}",
              clientSecret: "${{ secrets.BT_CLNT_SCRT }}",
              installationId: ${{ secrets.BT_INST_ID }},
            })({ type: "installation" })).token);
          }
          main();' | Out-File -FilePath auth.js

          # Install winget and enable local manifests since microsoft/winget-cli#1453 is merged
          Invoke-WebRequest -Uri 'https://aka.ms/Microsoft.VCLibs.x64.14.00.Desktop.appx' -OutFile 'VCLibs.appx'
          Invoke-WebRequest -Uri 'https://github.com/microsoft/winget-cli/releases/download/v1.1.12701/Microsoft.DesktopAppInstaller_8wekyb3d8bbwe.msixbundle' -OutFile 'winget.msixbundle'
          Invoke-WebRequest -Uri 'https://github.com/microsoft/winget-cli/releases/download/v1.1.12701/9c0fe2ce7f8e410eb4a8f417de74517e_License1.xml' -OutFile 'license.xml'
          Import-Module -Name Appx -UseWindowsPowerShell
          Add-AppxProvisionedPackage -Online -PackagePath .\winget.msixbundle -DependencyPackagePath .\VCLibs.appx -LicensePath .\license.xml
          # winget command on windows server -------------------
          # Source: https://github.com/microsoft/winget-cli/issues/144#issuecomment-849108158
          Install-Module NtObjectManager -Force # Install NtObjectManager module
          $installationPath = (Get-AppxPackage Microsoft.DesktopAppInstaller).InstallLocation # Create reparse point
          Set-ExecutionAlias -Path "C:\Windows\System32\winget.exe" -PackageName "Microsoft.DesktopAppInstaller_8wekyb3d8bbwe" -EntryPoint "Microsoft.DesktopAppInstaller_8wekyb3d8bbwe!winget" -Target "$installationPath\AppInstallerCLI.exe" -AppType Desktop -Version 3
          explorer.exe "shell:appsFolder\Microsoft.DesktopAppInstaller_8wekyb3d8bbwe!winget"
          # ----------------------------------------------------
          winget settings --enable LocalManifestFiles
          Write-Output " Successfully installed winget and enabled local manifests."

          # Install powershell-yaml, required for YamlCreate.ps1
          Install-Module -Name powershell-yaml -Repository PSGallery -Scope CurrentUser -Force
          Write-Output "Successfully installed powershell-yaml."
      - name: Run automation script
        run: .\src\Automation.ps1
        env:
          GITHUB_TOKEN: ${{ secrets.MYSUPERSECRETINFORMATION }}
